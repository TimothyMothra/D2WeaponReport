<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net5.0</TargetFramework>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.TypeScript.MSBuild" Version="4.4.4">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <ItemGroup>
    <!--<PackageReference Include="Microsoft.VisualStudio.Web.BrowserLink" Version="2.2.0" />-->
    
    <ProjectReference Include="..\DestinyLib\DestinyLib.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Folder Include="wwwroot\scripts\" />
  </ItemGroup>

  <Target Name="TypeScriptVerification" AfterTargets="Build">
    <!--DependsOnTargets BeforeBuild;CoreBuild;AfterBuild-->
    <PropertyGroup>
      <ExpectedTypescriptOutput_JS>$(SourceRoot)\SandboxWeb\wwwroot\scripts\app.js</ExpectedTypescriptOutput_JS>
      <ExpectedTypescriptOutput_TS>$(SourceRoot)\SandboxWeb\wwwroot\scripts\app.ts</ExpectedTypescriptOutput_TS>
      <ExpectedTypescriptOutput_JS_MAP>$(SourceRoot)\SandboxWeb\wwwroot\scripts\app.js.map</ExpectedTypescriptOutput_JS_MAP>

      <TypeScriptVerification_Name>TypeScriptVerification</TypeScriptVerification_Name>
      <TypeScriptVerification_Description>verify TypeScript was compiled and published to wwwroot.</TypeScriptVerification_Description>
      <TypeScriptVerification_HelpText>Confirm that file name hasn't changed. Output is configured in 'tsconfig.json'. This could be a problem with either Node or NPM. Also try manually restoring package.json.</TypeScriptVerification_HelpText>
    </PropertyGroup>
    <!--TODO: This works for VisualStudio Build. Does not work for dotnet CLI or VisualStudio Rebuild-->

    <Message Importance="high" Text="$(MSBuildProjectName): Run $(TypeScriptVerification_Name) - $(TypeScriptVerification_Description)" />
    <Message Importance="high" Text="$(TypeScriptVerification_Name) passed." Condition="Exists($(ExpectedTypescriptOutput_JS)) and Exists($(ExpectedTypescriptOutput_JS_MAP)) and Exists($(ExpectedTypescriptOutput_TS))" />
    <Message Importance="high" Text="$(TypeScriptVerification_Name) failed. $(TypeScriptVerification_HelpText)" Condition="!Exists($(ExpectedTypescriptOutput_JS)) or !Exists($(ExpectedTypescriptOutput_JS_MAP)) or !Exists($(ExpectedTypescriptOutput_TS))" />
    <Error Code="$(TypeScriptVerification_Name)" Text="TypeScript compiled output not found: '$(ExpectedTypescriptOutput_JS)'. $(TypeScriptVerification_HelpText)" Condition="!Exists($(ExpectedTypescriptOutput_JS))" ContinueOnError="ErrorAndContinue" />
    <Error Code="$(TypeScriptVerification_Name)" Text="TypeScript compiled output not found: '$(ExpectedTypescriptOutput_JS_MAP)'. $(TypeScriptVerification_HelpText)" Condition="!Exists($(ExpectedTypescriptOutput_JS_MAP))"  ContinueOnError="ErrorAndContinue" />
    <Error Code="$(TypeScriptVerification_Name)" Text="TypeScript compiled output not found: '$(ExpectedTypescriptOutput_TS)'. $(TypeScriptVerification_HelpText)" Condition="!Exists($(ExpectedTypescriptOutput_TS))"  ContinueOnError="ErrorAndContinue" />

</Target>

  <!--<UsingTask TaskName="VerifyTypescriptOutput">
    <ParameterGroup>
      <FilePath ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Message Importance="high" Text="Verify Typescript was compiled and published to wwwroot..." />
      <Message Importance="high" Text="File: '$(FilePath)' was found." Condition="Exists($(FilePath))" />
      <Message Importance="high" Text="File: '$(FilePath)' was NOT found! This is configured in 'tsconfig.json'. This could be a problem with either Node or NPM." Condition="!Exists($(FilePath))" />
      <Error Text="Typescript compiled output not found: '$(FilePath)'. This is configured in 'tsconfig.json'. This could be a problem with either Node or NPM." Condition="!Exists($(FilePath))" />  
    </Task> 
  </UsingTask>-->
  
</Project>
